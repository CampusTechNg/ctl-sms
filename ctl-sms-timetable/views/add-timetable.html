{{> header}}
<!-- BEGIN PAGE LEVEL PLUGINS -->
<link href="/public/ctl-sms-home/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet" type="text/css" />
<link href="/public/ctl-sms-home/assets/global/plugins/bootstrap-timepicker/css/bootstrap-timepicker.min.css" rel="stylesheet" type="text/css" />
<link href="/public/ctl-sms-home/assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" />
<link href="/public/ctl-sms-home/assets/global/plugins/clockface/css/clockface.css" rel="stylesheet" type="text/css" />

<link href="/public/ctl-sms-home/assets/global/plugins/fullcalendar/fullcalendar.min.css" rel="stylesheet" type="text/css" />
<link href="/public/bolt-ui-sweetalert/dist/sweetalert.css" rel="stylesheet" type="text/css" />
<!-- END PAGE LEVEL PLUGINS -->
{{> sub_header}}

{{> nav }}

<!-- BEGIN PAGE TITLE-->
<div class="container-fluid">
    <div class="col-md-12">
        <h3 class="page-title"> View Timetable</h3>
    </div>
</div>
<!-- END PAGE TITLE-->


<!-- BEGIN PAGE CONTENT-->
<div class="row">
    <div class="col-md-12">
        <div class="portlet light portlet-fit bordered calendar">
            <div class="portlet-title">
                <div class="caption">
                    <i class=" icon-layers font-green"></i>
                    <span class="caption-subject font-green sbold uppercase">Timetable</span>
                </div>
            </div>
            <div class="portlet-body">
                <div class="row">
                    <div class="col-md-3 col-sm-12">
                        <!-- BEGIN DRAGGABLE EVENTS PORTLET-->
                        <h3 class="event-form-title margin-bottom-20">Class Schedules</h3>
                        <div id="external-events">
                            <form class="inline-form" id="form_schedule">

                                <div class="col-md-12 col-sm-12">
                                    <div class="form-group form-md-line-input">
                                        <select name="classes" id="classes" class="form-control ">
                                            {{#each student_classes}}
                                            <option value="{{displayName}}">{{displayName}}</option>
                                            {{/each}}
                                        </select>
                                        <label for="classes" class="control-label">Classes</label>
                                    </div>                                
                                </div>

                                <div class="col-md-12 col-sm-12">
                                <div class="form-group form-md-line-input">
                                        <select name="event_title" id="event_title" class="form-control ">
                                            
                                            <option value="maths">Maths</option>
                                            <option value="english">English</option>
                                            <option value="chemistry">Chemistry</option>
                                            
                                        </select>
                                        <label for="event_title" class="control-label">Subject</label>
                                    </div> 
                                    
                                </div>

                                
                                <br/>
                                <label class="control-label col-md-12">Start</label>
                                <div class="col-md-12 col-sm-12">
                                
                                    <div class="input-group date form_datetime">
                                        <input id="start_time" type="text" size="16" readonly class="form-control">
                                        <span class="input-group-btn">
                                            <button class="btn default date-set" type="button">
                                                <i class="fa fa-calendar"></i>
                                            </button>
                                        </span>
                                    </div>
                                    
                                </div>
                                <br/><br/><br/>

                                <label class="control-label col-md-12">End</label>
                                <div class="col-md-12 col-sm-12">

                                <div class="input-group date form_datetime">
                                        <input id="end_time" type="text" size="16" readonly class="form-control">
                                        <span class="input-group-btn">
                                            <button class="btn default date-set" type="button">
                                                <i class="fa fa-calendar"></i>
                                            </button>
                                        </span>
                                    </div>
                                </div>
                                <br clear="all" /><br/>

                                <input type="submit" value="Add Schedule" class="btn green">
                            </form>

                            <hr/>
                            
                            <hr class="visible-xs" /> </div>
                            <!-- END DRAGGABLE EVENTS PORTLET-->
                        </div>
                        <div class="col-md-9 col-sm-12">
                            <div id="timetable" class="has-toolbar"> </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- END PAGE CONTENT-->
    {{> copyright }}

    {{> sub_footer }}

    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="/public/ctl-sms-home/assets/global/plugins/moment.min.js" type="text/javascript"></script>
    <script src="/public/ctl-sms-home/assets/global/plugins/fullcalendar/fullcalendar.js" type="text/javascript"></script>
    <script src="/public/ctl-sms-home/assets/global/plugins/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
    <script src="/public/ctl-sms-home/assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js" type="text/javascript"></script>
    <script src="/public/ctl-sms-home/assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>

    <script src="/public/ctl-sms-home/assets/pages/scripts/components-date-time-pickers.min.js" type="text/javascript"></script>

    <script src="/public/bolt-ui-sweetalert/dist/sweetalert.min.js" type="text/javascript"></script>
    <script src="/public/bolt-ui-sweetalert/dist/sweetalert-dev.js" type="text/javascript"></script>
    <script src="/public/ctl-sms-home/assets/global/plugins/clockface/js/clockface.js" type="text/javascript"></script>
    <!-- END PAGE LEVEL PLUGINS -->

    <script type="text/javascript">

    function modifyDate(curr_date,curr_week){
        var start_date=new Date(curr_date);
        var start_week=moment(start_date).get('week');
        //modify date
        if(curr_week > start_week){
            diff=curr_week - start_week;
            start_date=moment(start_date).add(diff, 'w');
            start_date=new Date(start_date);
        }else if (curr_week < start_week){
            diff=start_week-curr_week;
            start_date=moment(start_date).subtract(diff, 'w');
            start_date=new Date(start_date);
        }
        return start_date;
    }


        var AppCalendar = function() {

            return {
        //main function to initiate the module
        init: function() {
            this.initCalendar();
        },

        initCalendar: function() {

            if (!jQuery().fullCalendar) {
                return;
            }

            //get schedules for selected class
            var curr_class_code=$('#classes').val();
            var timetable=[];
            $.ajax({
                url:'{{bolt_root}}/api/db/timetable/find?class_code='+curr_class_code,
                type:'POST',   
                data: JSON.stringify({}),             
                dataType:'json',
                contentType:'application/json',
                headers:{'X-Bolt-App-Token':'{{app_token}}'},
                success:function(response,textStatus,jqXHR){
                    if(response.code===0){
                        var items =response.body;
                        if(items.length >0){
                            var item=items[0];
                            var diff=0;

                            var today = new Date();            
                            var mon = today.getMonth();
                            var yr = today.getFullYear();
                            var curr_week=moment(today).get('week');

                            timetable=$.map(item.schedules,function(value,index){                               

                                var start_date=modifyDate(value.start,curr_week);
                                var d1=start_date.getDate();
                                var h1=start_date.getHours();
                                var min1=start_date.getMinutes();
                                
                                var end_date=modifyDate(value.end,curr_week);
                                var d2=end_date.getDate();
                                var h2=end_date.getHours();
                                var min2=end_date.getMinutes();
                                var end_week=moment(end_date).get('week');

                                return {
                                    'title':value.title,
                                    'start':new Date(yr,mon,d1,h1,min1),
                                    'end':new Date(yr,mon,d2,h2,min2),
                                    'backgroundColor':App.getBrandColor(value.background_color)
                                }                                 
                            });                            

                        }

                        $('#timetable').fullCalendar('destroy'); // destroy the timetable
                            $('#timetable').fullCalendar({ //re-initialize the timetable
                                header: false,
                                defaultView: 'agendaWeek',                                 
                                events: timetable
                            });

                    }
                },
                error:function(xhr,status,err){
                   console.log(err);
               }

           });            

        }

    };

}();



$(document).ready(function(){

    jQuery(document).ready(function() {    
       AppCalendar.init(); 
   });

    $('#form_schedule').on('submit',function(e){
        e.preventDefault();
        var title=$('#event_title').val();

        var class_code=$('#classes').val();

        var start_time=$('#start_time').val();
        var start = moment(start_time,'DD MMMM YYYY - HH:mm');

        var end_time=$('#end_time').val();
        var end = moment(end_time,'DD MMMM YYYY - HH:mm');

        var curr_week=moment(end).get('week');

        var background_color='green';

            var schedule={class_code:class_code,start:start,end:end,background_color:background_color,title:title};

            $.ajax({
                url: '{{app_root}}/add_schedule',
                type: 'POST',
                data: JSON.stringify({ schedule }),
                contentType: 'application/json',
                headers: {'X-Bolt-App-Token': '{{app_token}}'},
                success: function(response,textStatus, jqXHR) {  
                    setTimeout(function(){
                        sweetAlert("Schedule Created", "", "success");
                        AppCalendar.init(); 
                    },500);
                    
                },
                error: function(xhr, status, err){
                    console.log(err);
                    console.log(xhr.responseText);
                }
            });
        })


});

</script>

<!-- END UNIQUE SCRIPT FOR ONLY THIS PAGE -->
{{> footer }}